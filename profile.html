<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - MMTS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root { --sidebar-width: 260px; --primary: #6366f1; --bg-body: #f3f4f6; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-body); overflow-x: hidden; }

        /* --- Sidebar & Mobile Menu --- */
        .sidebar { 
            width: var(--sidebar-width); height: 100vh; position: fixed; left: 0; top: 0; 
            background: #111827; padding: 25px; z-index: 1050; transition: 0.3s; 
            display: flex; flex-direction: column; 
        }
        .sidebar-brand { color: white; font-size: 1.5rem; font-weight: bold; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-link { color: #9ca3af; padding: 12px 15px; border-radius: 12px; margin-bottom: 5px; display: flex; align-items: center; gap: 12px; transition: 0.2s; text-decoration: none; font-weight: 500; cursor: pointer; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); color: #fff; }
        
        .main-content { margin-left: var(--sidebar-width); padding: 0; transition: 0.3s; }
        .mobile-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1040; }

        /* Mobile Responsive Rules */
        @media (max-width: 768px) {
            .sidebar { left: -100%; } /* ซ่อนเมนู */
            .sidebar.active { left: 0; } /* แสดงเมนู */
            .main-content { margin-left: 0; } /* ขยายเนื้อหาเต็มจอ */
            .mobile-overlay.active { display: block; }
            .mobile-menu-btn { display: inline-block !important; }
            .hide-on-mobile { display: none !important; }
            
            /* ปรับ Header บนมือถือ */
            .profile-info-bar { flex-direction: column; align-items: center; text-align: center; padding-bottom: 20px; }
            .profile-avatar-wrapper { flex-direction: column; align-items: center; margin-top: -50px; }
            .profile-names { margin-top: 10px; }
            .profile-stats { margin: 15px 0; }
            .profile-tabs { overflow-x: auto; white-space: nowrap; padding: 0 10px; gap: 20px; }
            .cover-image { height: 180px; }
        }

        /* --- Profile Header --- */
        .profile-header { position: relative; background: white; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .cover-image { height: 250px; width: 100%; object-fit: cover; background: linear-gradient(to right, #1e3c72, #2a5298); }
        
        /* Mobile Menu Button (Absolute on top left) */
        .mobile-menu-btn { 
            display: none; position: absolute; top: 20px; left: 20px; z-index: 100; 
            background: rgba(255,255,255,0.9); border: none; padding: 8px 12px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .profile-info-bar { padding: 0 40px 30px 40px; position: relative; display: flex; justify-content: space-between; align-items: flex-end; }
        .profile-avatar-wrapper { margin-top: -60px; display: flex; gap: 20px; align-items: flex-end; }
        .profile-avatar { width: 140px; height: 140px; border-radius: 20px; border: 5px solid white; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.1); background: white; }
        .profile-names h2 { margin: 0; font-weight: bold; color: #1f2937; }
        
        .profile-stats { display: flex; gap: 30px; text-align: center; }
        .stat-num { font-weight: bold; font-size: 1.2rem; display: block; }
        .stat-lbl { font-size: 0.8rem; color: #6b7280; text-transform: uppercase; letter-spacing: 1px; }

        /* Tabs */
        .profile-tabs { display: flex; gap: 40px; padding: 0 40px; border-bottom: 1px solid #e5e7eb; background: white; }
        .tab-item { padding: 15px 5px; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; font-size: 0.95rem; transition: 0.3s; }
        .tab-item:hover, .tab-item.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* Content */
        .content-area { padding: 30px 40px; }
        @media (max-width: 768px) { .content-area { padding: 20px; } } /* ลด padding บนมือถือ */

        .modern-card { background: white; border-radius: 20px; padding: 30px; border: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); height: 100%; }

        /* Job Card */
        .job-card { background: white; border-radius: 16px; overflow: hidden; transition: 0.3s; border: 1px solid #f3f4f6; position: relative; height: 100%; display: flex; flex-direction: column; }
        .job-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); border-color: #e0e7ff; }
        .job-img-area { height: 160px; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; position: relative; }
        .bg-repair { background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); color: #4338ca; }
        .bg-install { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); color: #15803d; }
        .job-status-badge { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.95); padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .job-body { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .job-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }

        /* Form Custom */
        .form-label-custom { font-size: 0.85rem; font-weight: bold; color: #6b7280; margin-bottom: 5px; }
        .form-control-custom { border-radius: 10px; padding: 10px 15px; border: 1px solid #e5e7eb; background: #f9fafb; width: 100%; }
        .form-control-custom:focus { background: white; border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        
        .fade-in { animation: fadeIn 0.4s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="mobile-overlay" onclick="toggleMenu()"></div>
<div class="sidebar" id="sidebar">
    <div class="sidebar-brand"><i class="bi bi-robot"></i> <span>Siamthaisteel</span></div>
    <a href="dashboard.html" class="nav-link"><i class="bi bi-grid-fill"></i> ภาพรวมงาน</a>
    <a href="#" class="nav-link active"><i class="bi bi-person-circle"></i> โปรไฟล์ของฉัน</a>
    <a href="admin.html" id="btnAdminLink" class="nav-link text-warning d-none mt-3 border border-warning"><i class="bi bi-shield-lock-fill"></i> แอดมิน (Admin)</a>
    <div class="mt-auto"><a href="#" onclick="logout()" class="nav-link text-danger"><i class="bi bi-box-arrow-right"></i> ออกจากระบบ</a></div>
</div>

<div class="main-content">
    
    <div class="profile-header">
        <button class="mobile-menu-btn" onclick="toggleMenu()"><i class="bi bi-list fs-4"></i></button>

        <div class="cover-image" style="background-image: url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2070&auto=format&fit=crop');"></div>
        
        <div class="profile-info-bar">
            <div class="profile-avatar-wrapper">
                <img src="" id="profileAvatar" class="profile-avatar">
                <div class="profile-names">
                    <h2 id="profileName">Loading...</h2>
                    <div class="text-muted" id="profileRole">Technician</div>
                </div>
            </div>
            
            <div class="profile-stats">
                <div><span class="stat-num text-primary" id="statRepairCount">0</span><span class="stat-lbl">งานซ่อม</span></div>
                <div style="border-left: 1px solid #e5e7eb; margin: 0 5px;"></div>
                <div><span class="stat-num text-success" id="statInstallCount">0</span><span class="stat-lbl">งานติดตั้ง</span></div>
            </div>

            <div class="d-none d-md-flex gap-2 mb-2">
                <button class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" onclick="saveProfile()"><i class="bi bi-save"></i> บันทึก</button>
            </div>
        </div>

        <div class="profile-tabs">
            <div class="tab-item active" onclick="switchTab('about', this)"><i class="bi bi-person"></i> เกี่ยวกับฉัน</div>
            <div class="tab-item" onclick="switchTab('repairs', this)"><i class="bi bi-wrench"></i> ประวัติซ่อม</div>
            <div class="tab-item" onclick="switchTab('installs', this)"><i class="bi bi-rocket-takeoff"></i> ประวัติติดตั้ง</div>
        </div>
    </div>

    <div class="content-area">
        
        <div id="tab-about" class="row g-4 fade-in">
            <div class="col-lg-8">
                <div class="modern-card">
                    <h5 class="fw-bold mb-4">ข้อมูลส่วนตัว (About Me)</h5>
                    <p class="text-muted" style="line-height: 1.8;">
                        ยินดีต้อนรับสู่หน้าโปรไฟล์ของคุณ! นี่คือพื้นที่สำหรับแสดงข้อมูลการทำงานและความเชี่ยวชาญของคุณ 
                        ในฐานะทีมงาน MMTS System เรามุ่งมั่นที่จะให้บริการที่มีคุณภาพสูงสุดแก่ลูกค้า
                    </p>
                    
                    <h6 class="fw-bold mt-5 mb-3">ความเชี่ยวชาญ (Skills)</h6>
                    <div class="d-flex gap-2 flex-wrap">
                        <span class="badge bg-light text-dark border px-3 py-2 rounded-pill">ซ่อมบำรุงเครื่องจักร</span>
                        <span class="badge bg-light text-dark border px-3 py-2 rounded-pill">ติดตั้งระบบไฟฟ้า</span>
                        <span class="badge bg-light text-dark border px-3 py-2 rounded-pill">ตรวจสอบความปลอดภัย</span>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="modern-card">
                    <h5 class="fw-bold mb-4">แก้ไขข้อมูล (Edit Profile)</h5>
                    <form id="profileForm">
                        <div class="mb-3">
                            <label class="form-label-custom">Username</label>
                            <input type="text" id="inpUser" class="form-control-custom" disabled style="opacity: 0.7;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label-custom">ชื่อ-นามสกุล</label>
                            <input type="text" id="inpName" class="form-control-custom">
                        </div>
                        <div class="mb-3">
                            <label class="form-label-custom">เบอร์โทรศัพท์</label>
                            <input type="text" id="inpTel" class="form-control-custom" placeholder="08x-xxx-xxxx">
                        </div>
                        <div class="mb-3">
                            <label class="form-label-custom">รหัสผ่านใหม่ (ว่างไว้ถ้าไม่เปลี่ยน)</label>
                            <input type="password" id="inpPass" class="form-control-custom" placeholder="••••••">
                        </div>
                        <hr class="text-muted my-4">
                        <div class="mb-3">
                            <label class="form-label-custom">อัปโหลดรูปโปรไฟล์ใหม่</label>
                            <input type="file" id="inpFile" class="form-control form-control-sm" accept="image/*" onchange="previewImage(this)">
                        </div>
                        <button type="button" class="btn btn-primary w-100 rounded-pill fw-bold d-md-none" onclick="saveProfile()">บันทึกข้อมูล</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="tab-repairs" class="row g-4 d-none fade-in"></div>

        <div id="tab-installs" class="row g-4 d-none fade-in"></div>

    </div>
</div>

<script>
    const API_URL = "http://127.0.0.1:5000/api";
    const currentUser = localStorage.getItem('mmts_user');
    const currentRole = localStorage.getItem('mmts_role');
    let myUserData = null;

    if(!currentUser) location.href='login.html';
    if(currentRole==='MANAGER') document.getElementById('btnAdminLink').classList.remove('d-none');

    // Toggle Menu Function
    function toggleMenu() {
        document.getElementById('sidebar').classList.toggle('active');
        document.querySelector('.mobile-overlay').classList.toggle('active');
    }

    async function init() {
        try {
            const [uRes, rRes, iRes] = await Promise.all([
                fetch(`${API_URL}/users`).catch(()=>null), 
                fetch(`${API_URL}/repairs`).catch(()=>null), 
                fetch(`${API_URL}/installs`).catch(()=>null)
            ]);
            
            const users = uRes ? await uRes.json() : [];
            const repairs = rRes ? await rRes.json() : [];
            const installs = iRes ? await iRes.json() : [];

            // 1. Setup Profile
            myUserData = users.find(u => u.name === currentUser);
            if(myUserData) {
                const avatar = myUserData.avatar ? `${API_URL.replace('/api','')}/uploads/${myUserData.avatar}` : `https://ui-avatars.com/api/?name=${currentUser}&background=random&size=200`;
                document.getElementById('profileAvatar').src = avatar;
                document.getElementById('profileName').innerText = myUserData.name;
                document.getElementById('profileRole').innerText = myUserData.role === 'MANAGER' ? 'Manager & Admin' : 'Professional Technician';
                
                document.getElementById('inpUser').value = myUserData.u;
                document.getElementById('inpName').value = myUserData.name;
                document.getElementById('inpTel').value = myUserData.tel || '';
            }

            // 2. Filter Jobs
            document.getElementById('statRepairCount').innerText = repairs.length;
            document.getElementById('statInstallCount').innerText = installs.length;

            renderRepairs(repairs);
            renderInstalls(installs);

        } catch (e) { console.error(e); }
    }

    function renderRepairs(jobs) {
        const container = document.getElementById('tab-repairs');
        container.innerHTML = '';
        if(jobs.length === 0) { container.innerHTML = '<div class="col-12 text-center text-muted py-5">ยังไม่มีประวัติงานซ่อม</div>'; return; }

        jobs.forEach(job => {
            const statusColor = job.status === 'COMPLETED' ? 'text-success' : 'text-primary';
            container.innerHTML += `
            <div class="col-12 col-md-6 col-xl-3">
                <div class="job-card">
                    <span class="job-status-badge ${statusColor}"><i class="bi bi-circle-fill small me-1"></i>${job.status}</span>
                    <div class="job-img-area bg-repair"><i class="bi bi-tools"></i></div>
                    <div class="job-body">
                        <div class="job-title text-truncate">${job.customer}</div>
                        <div class="job-meta"><i class="bi bi-hdd-network"></i> ${job.machineName || '-'}</div>
                        <p class="small text-muted mb-3 flex-grow-1 text-truncate">${job.problem}</p>
                        <div class="job-footer">
                            <small class="text-muted"><i class="bi bi-calendar3"></i> ${job.serviceDate}</small>
                        </div>
                    </div>
                </div>
            </div>`;
        });
    }

    function renderInstalls(jobs) {
        const container = document.getElementById('tab-installs');
        container.innerHTML = '';
        if(jobs.length === 0) { container.innerHTML = '<div class="col-12 text-center text-muted py-5">ยังไม่มีประวัติงานติดตั้ง</div>'; return; }

        jobs.forEach(job => {
            const statusColor = job.status === 'COMPLETED' ? 'text-success' : 'text-warning';
            container.innerHTML += `
            <div class="col-12 col-md-6 col-xl-3">
                <div class="job-card">
                    <span class="job-status-badge ${statusColor}"><i class="bi bi-circle-fill small me-1"></i>${job.status}</span>
                    <div class="job-img-area bg-install"><i class="bi bi-rocket-takeoff"></i></div>
                    <div class="job-body">
                        <div class="job-title text-truncate">${job.project}</div>
                        <div class="job-meta"><i class="bi bi-geo-alt"></i> ${job.location}</div>
                        <div class="job-footer">
                            <small class="text-muted"><i class="bi bi-calendar-event"></i> ${job.startDate}</small>
                        </div>
                    </div>
                </div>
            </div>`;
        });
    }

    function switchTab(tabName, el) {
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        ['about', 'repairs', 'installs'].forEach(t => document.getElementById('tab-'+t).classList.add('d-none'));
        document.getElementById('tab-' + tabName).classList.remove('d-none');
    }

    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById('profileAvatar').src = e.target.result; }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function saveProfile() {
        const newName = document.getElementById('inpName').value;
        const newTel = document.getElementById('inpTel').value;
        const newPass = document.getElementById('inpPass').value;
        const fileInput = document.getElementById('inpFile');

        let avatar = myUserData.avatar;
        if(fileInput.files.length > 0) {
            const fd = new FormData(); fd.append('file', fileInput.files[0]);
            try {
                const res = await fetch(`${API_URL}/upload`, {method:'POST', body:fd});
                const d = await res.json();
                if(d.filename) avatar = d.filename;
            } catch(e) { return Swal.fire('Error', 'Upload failed', 'error'); }
        }

        const payload = { name: newName, tel: newTel, avatar: avatar };
        if(newPass) payload.p = newPass;

        const res = await fetch(`${API_URL}/users/${myUserData.u}`, {
            method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        
        if(res.ok) {
            localStorage.setItem('mmts_user', newName);
            Swal.fire('บันทึกสำเร็จ!', 'ข้อมูลอัปเดตเรียบร้อย', 'success').then(()=>location.reload());
        } else {
            Swal.fire('ผิดพลาด', 'บันทึกไม่ได้', 'error');
        }
    }

    function logout() { localStorage.clear(); location.href='login.html'; }
    init();
</script>

</body>
</html>